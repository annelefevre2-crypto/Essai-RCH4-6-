<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistance op√©rationnelle par IA - RCH4</title>

  <!-- Librairies externes -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>

  <!-- Styles visuels -->
  <style>
    body { margin:0; font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#F0F4F9; color:#e5e7eb; }
    header { padding:14px 18px; background:linear-gradient(90deg,#2B4570,#4E78BC); color:#FDFFFC; font-weight:800; }
    main { max-width:980px; margin:24px auto; padding:0 16px 40px; display:grid; gap:16px; }
    .card { background:#C1292E; border:1px solid #F4CDCE; border-radius:16px; padding:16px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button { background:#06b6d4; border:none; color:#001018; font-weight:700; padding:10px 14px; border-radius:10px; cursor:pointer; }
    button.secondary { background:transparent; border:1px solid #334155; color:#e5e7eb; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    video, canvas { width:100%; border-radius:12px; background:#0f172a; border:1px dashed #334155; min-height:260px; display:block; }
    textarea { width:100%; min-height:220px; border-radius:12px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; padding:12px; font-size:14px; }
    .hint { color:#94a3b8; font-size:12px; }
    .progress { height:6px; background:#0b1220; border-radius:999px; overflow:hidden; border:1px solid #1f2a3a; }
    .bar { height:100%; width:0; background:#06b6d4; transition:width .3s ease; }
  </style>
</head>

<body>
<header>
  Assistance op√©rationnelle par IA - RCH4
</header>

<main>
  <!-- SECTION 1 : acquisition -->
  <section class="card">
    <h2>1Ô∏è‚É£ Prendre une photo ou importer une fiche</h2>
    <div class="row">
      <button id="btnStart">Activer la cam√©ra</button>
      <button id="btnShot" class="secondary" disabled>Capturer</button>
      <input id="file" type="file" accept="image/*,.pdf" capture="environment" style="display:none">
      <button id="btnUpload" class="secondary">Importer une image ou PDF</button>
    </div>
    <div class="hint">
      La fiche doit pr√©senter 4 carr√©s noirs aux coins de la zone blanche. Le QR code reste dans le bandeau bleu.
    </div>
    <video id="video" playsinline></video>
    <canvas id="canvas" hidden></canvas>
  </section>

  <!-- SECTION 2 : traitement -->
  <section class="card">
    <h2>2Ô∏è‚É£ Traitement (OCR zone blanche + lecture QR)</h2>
    <div class="row">
      <button id="btnProcess" disabled>Lancer le traitement</button>
      <button id="btnClear" class="secondary">Effacer</button>
    </div>
    <div class="progress" style="margin:10px 0"><div id="bar" class="bar"></div></div>
    <div id="status" class="hint">Pr√™t.</div>
    <textarea id="result" placeholder="Texte OCR (zone blanche) + QR code‚Ä¶"></textarea>
  </section>

  <!-- SECTION 3 : g√©n√©ration du prompt -->
  <section class="card">
    <h2>3Ô∏è‚É£ G√©n√©rer un prompt RCH4 et l‚Äôenvoyer √† ChatGPT</h2>
    <textarea id="prompt"></textarea>
    <div class="row" style="margin-top:10px">
      <button id="btnOpen">Ouvrir dans ChatGPT</button>
      <button id="btnCopy" class="secondary">Copier le prompt</button>
    </div>
  </section>
</main>

<script>
/* ---------------------------------------------------------
   üì¶ Initialisation & variables
--------------------------------------------------------- */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let capturedImage = null;

const btnStart = document.getElementById('btnStart');
const btnShot = document.getElementById('btnShot');
const btnUpload = document.getElementById('btnUpload');
const fileInput = document.getElementById('file');
const btnProcess = document.getElementById('btnProcess');
const btnClear = document.getElementById('btnClear');
const statusEl = document.getElementById('status');
const bar = document.getElementById('bar');
const resultEl = document.getElementById('result');
const promptEl = document.getElementById('prompt');

function setStatus(msg, progress = 0) {
  statusEl.textContent = msg;
  bar.style.width = (progress * 100) + "%";
}
function showCanvas() { video.hidden = true; canvas.hidden = false; }

/* ---------------------------------------------------------
   üé• Capture cam√©ra ou import
--------------------------------------------------------- */
btnStart.onclick = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    await video.play();
    btnShot.disabled = false;
    setStatus("Cam√©ra activ√©e");
  } catch (err) {
    alert("Erreur cam√©ra : " + err.message);
  }
};

btnShot.onclick = () => {
  const w = video.videoWidth || 1280;
  const h = video.videoHeight || 720;
  canvas.width = w; canvas.height = h;
  ctx.drawImage(video, 0, 0, w, h);
  capturedImage = canvas.toDataURL("image/png");
  showCanvas();
  btnProcess.disabled = false;
};

btnUpload.onclick = () => fileInput.click();

fileInput.onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  if (file.type === "application/pdf") {
    // PDF ‚Üí image
    const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
    const page = await pdf.getPage(1);
    const vp = page.getViewport({ scale: 2 });
    canvas.width = vp.width; canvas.height = vp.height;
    await page.render({ canvasContext: ctx, viewport: vp }).promise;
  } else {
    const img = new Image();
    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
    };
    img.src = URL.createObjectURL(file);
  }
  capturedImage = canvas.toDataURL("image/png");
  showCanvas();
  btnProcess.disabled = false;
};

btnClear.onclick = () => {
  resultEl.value = "";
  promptEl.value = "";
  bar.style.width = "0%";
  setStatus("Pr√™t.");
  downscaleIfNeeded()
};

  function detectFourCorners(step = 3, darkThreshold = 50) {
  const { width, height } = canvas;
  const img = ctx.getImageData(0, 0, width, height);
  const d = img.data;

  // bornes initialis√©es sans cr√©er de gros tableaux
  let minX = width, minY = height, maxX = 0, maxY = 0, hits = 0;

  for (let y = 0; y < height; y += step) {
    for (let x = 0; x < width; x += step) {
      const i = (y * width + x) * 4;
      const Y = 0.2126 * d[i] + 0.7152 * d[i + 1] + 0.0722 * d[i + 2]; // luminance
      if (Y < darkThreshold) {
        hits++;
        if (x < minX) minX = x;
        if (x > maxX) maxX = x;
        if (y < minY) minY = y;
        if (y > maxY) maxY = y;
      }
    }
  }

  if (hits < 300) return null; // pas assez de points sombres ‚Üí cadre non trouv√©

  // marge pour ne pas inclure les carr√©s eux-m√™mes
  const pad = Math.round(Math.min(width, height) * 0.03);
  return {
    minX: Math.max(0, minX + pad),
    minY: Math.max(0, minY + pad),
    maxX: Math.min(width,  maxX - pad),
    maxY: Math.min(height, maxY - pad)
  };
}



/* Recadre le canvas √† la zone d√©tect√©e */
function cropToBox(box) {
  const w = box.maxX - box.minX;
  const h = box.maxY - box.minY;
  const temp = document.createElement("canvas");
  temp.width = w; temp.height = h;
  temp.getContext("2d").drawImage(canvas, box.minX, box.minY, w, h, 0, 0, w, h);
  canvas.width = w; canvas.height = h;
  ctx.drawImage(temp, 0, 0);
}

/* ---------------------------------------------------------
   üîé Lecture du QR + OCR de la zone recadr√©e
--------------------------------------------------------- */
function readQR() {
  const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const qr = jsQR(img.data, canvas.width, canvas.height, { inversionAttempts: "attemptBoth" });
  return qr ? qr.data : "";
}

async function doOCR(dataURL) {
  const res = await Tesseract.recognize(dataURL, "fra+eng", {
    langPath: "https://tessdata.projectnaptha.com/4.0.0_best/",
    tessedit_pageseg_mode: "6",
    preserve_interword_spaces: "1"
  });
  return res.data.text || "";
}

/* ---------------------------------------------------------
   üöÄ Pipeline principal
--------------------------------------------------------- */
btnProcess.onclick = async () => {
  if (!capturedImage) return alert("Aucune image disponible");

  try {
    setStatus("D√©tection du QR code‚Ä¶", 0.1);
    const qr = readQR();

    setStatus("D√©tection des 4 coins noirs‚Ä¶", 0.2);
    const zone = detectFourCorners(3, 50);
    if (zone) cropToBox(zone);
    else setStatus("Cadre non d√©tect√©, OCR sur toute l'image", 0.25);

    setStatus("OCR en cours‚Ä¶", 0.5);
    const text = await doOCR(canvas.toDataURL("image/png"));

    const combined = `# Texte OCR (zone blanche)\n${text}\n\n# QR code\n${qr || "(aucun QR d√©tect√©)"}`;
    resultEl.value = combined;

    const prompt = `Assistant IA RCH4 : exploite les donn√©es suivantes pour aider le conseiller technique √† :\n- analyser le produit (ONU, danger, CAS)\n- interpr√©ter les donn√©es chimiques/toxiques\n- proposer une synth√®se utilisable sur intervention\n---\n${combined}`;
    promptEl.value = prompt;
    setStatus("Termin√©", 1);
  } catch (err) {
    alert("Erreur : " + err.message);
    setStatus("Erreur", 1);
  }
};

/* ---------------------------------------------------------
 Redimensionner avant d√©tection (utile sur des photos 4K) :
--------------------------------------------------------- */

function downscaleIfNeeded(maxDim = 1600) {
  const { width, height } = canvas;
  const scale = Math.min(1, maxDim / Math.max(width, height));
  if (scale === 1) return;
  const tmp = document.createElement('canvas');
  tmp.width = Math.round(width * scale);
  tmp.height = Math.round(height * scale);
  tmp.getContext('2d').drawImage(canvas, 0, 0, tmp.width, tmp.height);
  canvas.width = tmp.width; canvas.height = tmp.height;
  ctx.drawImage(tmp, 0, 0);
}
  
/* ---------------------------------------------------------
   üì§ Boutons d‚Äôaction : copier / ouvrir ChatGPT
--------------------------------------------------------- */
document.getElementById("btnCopy").onclick = async () => {
  await navigator.clipboard.writeText(promptEl.value || resultEl.value || "");
  alert("Prompt copi√© !");
};

document.getElementById("btnOpen").onclick = () => {
  const q = encodeURIComponent(promptEl.value || resultEl.value || "");
  if (!q) return alert("Prompt vide");
  window.open("https://chat.openai.com/?q=" + q, "_blank");
};
</script>
</body>
</html>
